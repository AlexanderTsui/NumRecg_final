# 手写数字识别系统

## 项目概述

这是一个基于鼠标绘制的手写数字识别系统，允许用户通过鼠标在屏幕上书写数字，系统实时捕捉笔迹，并通过预训练的CNN神经网络模型自动识别手写数字。该系统包含完整的笔迹捕捉、图像处理、数字识别和串口通讯流程，适用于手写数字识别的演示、教学以及与外部设备进行数据交互。

## 功能特性

### 鼠标笔迹捕捉模块

- **全屏绘制区域**：整个屏幕作为绘制区域，提供最大化的书写空间
- **实时笔迹追踪**：用户按住鼠标左键绘制，系统实时记录轨迹
- **智能笔迹合并**：
  - 松开鼠标左键后的2秒内可继续书写
  - 系统自动合并多个笔迹片段，支持分段书写
  - 超过2秒未继续则视为完成当前数字
- **自动处理**：
  - 笔迹完成后自动加粗处理，提高识别准确率
  - 自动保存笔迹图像，无需用户操作
- **无干扰设计**：不弹出干扰性窗口，保持专注的书写体验
- **智能重置**：新一轮书写时自动清空画布，操作流畅自然

### 图像处理模块

- **智能裁剪算法**：
  - 自动检测笔迹边界并计算最佳裁剪区域
  - 保留1.5倍边距，避免笔迹被裁切
  - 生成规范的正方形裁剪区域
- **标准化处理**：
  - 精确缩放至28×28像素，符合模型输入标准
  - 二值化处理，提高特征清晰度
  - 转换为黑底白字格式，与MNIST训练集保持一致
  - 归一化处理，像素值范围标准化为0-1
- **完整处理流程记录**：
  - 按时间戳组织存储目录，清晰区分每次运行
  - 保存处理各阶段的图像（原始、裁剪、缩放、二值化、归一化）
  - 自动生成可视化图像，展示完整处理流程

### 数字识别模块

- **CNN卷积神经网络识别**：基于MNIST数据集预训练的深度学习模型
- **高效识别**：快速识别0-9的手写数字
- **结果可视化**：
  - 在控制台显示识别结果和置信度
  - 自动生成并保存带识别结果的图像
- **错误容错机制**：即使模型加载失败，捕捉和处理功能仍可正常运行

### 串口通讯模块

- **交互式设置**：程序启动时询问用户选择所需串口和波特率
- **自动检测**：自动列出系统中所有可用串口及其描述信息
- **灵活配置**：支持自定义波特率，默认9600
- **实时传输**：每次成功识别后自动发送识别结果到外部设备
- **容错机制**：
  - 无可用串口时不影响主程序运行
  - 串口通讯失败时有友好的错误提示
  - 支持用户选择跳过串口功能
- **数据格式化**：以标准格式`DIGIT:{数字},CONF:{置信度}`发送数据
- **自动资源释放**：程序退出时自动关闭串口连接

## 系统架构

```
project/
├── src/                          # 源代码目录
│   ├── main.py                   # 主程序入口
│   ├── module/                   # 功能模块目录
│   │   ├── mouse_capture.py      # 鼠标笔迹捕捉模块
│   │   ├── image_process.py      # 图像处理模块
│   │   ├── detect.py             # 数字识别模块
│   │   └── serial_communication.py # 串口通讯模块
├── models/                       # 模型目录
│   └── model_Mnist.pth           # 预训练CNN模型
├── output/                       # 输出目录（自动创建）
│   └── YYYYMMDD_HHMMSS/          # 按时间戳命名的子目录
│       ├── handwritten_001.png   # 原始笔迹图像
│       ├── *_cropped.png         # 裁剪后的图像
│       ├── *_resized.png         # 缩放后的图像
│       ├── *_binary.png          # 二值化后的图像
│       ├── *_normalized.png      # 归一化后的图像
│       ├── *_visualization.png   # 处理步骤可视化图像
│       └── *_result.png          # 包含识别结果的图像
├── requirements.txt              # 项目依赖列表
└── README.md                     # 项目说明文档
```

## 技术实现细节

- **鼠标捕捉技术**：使用pynput库监听和处理鼠标事件
- **图像处理**：
  - 使用OpenCV (cv2) 进行图像处理和变换
  - 使用PIL/Pillow进行图像格式转换
  - 使用NumPy进行矩阵运算和数据处理
- **可视化**：使用Matplotlib生成图像和结果可视化
- **深度学习框架**：基于PyTorch实现CNN模型加载和推理
- **多线程技术**：使用threading模块实现计时器功能
- **串口通讯**：使用PySerial库实现与外部设备的串口通信

## 环境需求

- **Python 版本**：3.8+ 
- **主要依赖**：
  - numpy==1.24.3
  - pynput==1.7.6
  - matplotlib==3.7.1
  - opencv-python==4.7.0.72
  - torch==1.13.1
  - torchvision==0.14.1
  - pillow==9.5.0
  - pyautogui==0.9.54
  - pyserial==3.5

## 安装指南

1. 克隆项目到本地：
   ```bash
   git clone <repository-url>
   cd handwritten-digit-recognition
   ```

2. 创建并激活虚拟环境（推荐，但可选）：
   ```bash
   python -m venv venv
   # Windows
   venv\Scripts\activate
   # macOS/Linux
   source venv/bin/activate
   ```

3. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```

## 使用方法

### 启动程序

```bash
python src/main.py
```

### 操作指南

1. 程序启动后，系统会检测可用串口并提示用户选择：
   - 输入对应编号选择要使用的串口
   - 输入波特率（默认9600）
   - 输入'q'可跳过串口功能
2. 整个屏幕将作为绘制区域
3. 系统会在output目录下创建一个以当前时间戳命名的文件夹
4. 使用鼠标左键书写数字：
   - 按住左键绘制
   - 松开后可在2秒内继续绘制（系统会提示）
   - 超过2秒则完成当前数字
5. 数字完成后，系统自动处理：
   - 保存原始图像和各处理阶段图像
   - 进行数字识别并显示结果
   - 将识别结果通过串口发送到外部设备
   - 自动准备下一次书写（无需手动清屏）
6. 按Ctrl+C随时退出程序

### 输出文件说明

每次绘制完成后，系统会在时间戳目录下保存以下文件：
- `handwritten_001.png`：原始笔迹图像
- `handwritten_001_cropped.png`：裁剪后的图像
- `handwritten_001_resized.png`：缩放至28×28的图像
- `handwritten_001_binary.png`：二值化后的图像
- `handwritten_001_normalized.png`：归一化后的图像
- `handwritten_001_visualization.png`：完整处理流程图
- `handwritten_001_result.png`：包含识别结果的图像

## 模型说明

- 系统使用预训练的CNN模型，存储在`models/model_Mnist.pth`
- 该模型基于MNIST数据集训练，专门识别0-9的手写数字
- 识别结果包含预测的数字和对应置信度（0-1之间）
- 置信度表示模型对预测结果的确信程度

## 常见问题与解决方案

- **问题**：识别准确率不理想
  **解决方案**：尝试调整线条粗细？效果比较一般（修改`mouse_capture.py`中的`line_thickness`参数）

- **问题**：无法启动程序
  **解决方案**：确认已安装所有依赖，并检查Python版本是否兼容

- **问题**：模型加载失败
  **解决方案**：确认`models`目录中存在正确的模型文件，并验证PyTorch版本兼容性

- **问题**：无法检测到串口或连接失败
  **解决方案**：
  - 确认USB串口设备已正确连接到计算机
  - 确认已安装正确的串口驱动程序
  - 尝试使用设备管理器查看可用COM端口
  - 可能需要管理员权限运行程序
  - 检查USB线缆是否损坏

## 贡献指南

欢迎对本项目提出改进建议或直接贡献代码。贡献时请遵循以下步骤：

1. Fork本仓库
2. 创建您的特性分支 (`git checkout -b feature/amazing-feature`)
3. 提交您的更改 (`git commit -m 'Add some amazing feature'`)
4. 推送到分支 (`git push origin feature/amazing-feature`)
5. 创建一个Pull Request

## 许可证

本项目采用MIT许可证 - 详见LICENSE文件 